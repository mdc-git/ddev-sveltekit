#!/usr/bin/env bash

## Description: Get container ip
## Usage: getip
## Example: "ddev getip"

set -o pipefail 
set -o errexit 
set -o nounset

HJSON="hjson-linux64"
JQ="jq-linux64"
CONFIG="${HOME}/.config/Code/User/settings.json"
PROFILE="Attach to remote node - Server Side Debugging"
BACKUPFILE=$(mktemp)
TMPFILE=$(mktemp)

cp ${CONFIG} ${BACKUPFILE}
ADDRESS=$(docker network inspect ddev-${DDEV_PROJECT}_default | jq .[].Containers[].IPv4Address | xargs echo | awk -F/ '{print $1}')
echo ${ADDRESS}
hjson -j ${CONFIG} | jq --arg name "${PROFILE}" --arg new_address "${ADDRESS}" '(.launch.configurations[] | select(.name == $name)).address = $new_address' > ${TMPFILE}
mv ${TMPFILE} ${CONFIG}